= Configuring API Gateway API Autodiscovery in a Mule 4 Application
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]

To configure API Autodiscovery in your Mule 4.x application, you must meet the following requirements:

== Make Your API available in API Manager

The API with which you want to pair your Mule application must be available in API Manager. +
You can either:

* Publish your API in **Exchange** and import it into API Manager. +
See xref:manage-exchange-api-task.adoc[Managing an API from Exchange].
* Import it directly from your machine. +
See xref:import-api-task.adoc[Importing an API Instance] for more details.

API Manager generates an "API ID" identifier for every imported API, as shown in the following screenshot:

image::api-id.png[align=center]

This "API ID" is required by the Autodiscovery element to identify the API with which you want to pair your application.

== Configure API Manager

This step is necessary to instruct API Manager to use your deployed Mule application as the API proxy itself.

. For **Managing Type**, select **Basic Endpoint**.
. Add the **Implementation URI** that points to the deployed Mule application.
. Select the checkmark `Check this box if you are managing this API in Mule 4 or above`.

== Configure Anypoint Platform Organization Credentials in Mule

To use Autodiscovery in a Mule application, launch Mule with already configured Anypoint Platform organization credentials. +
Learn how to configure your organization credentials based on your deployment target in xref:org-credentials-config-mule4.adoc[Configuring Organization Credentials in Mule Runtime 4].

== Configure the Autodiscovery Element in Your Mule Application

[TIP]
If you configured a proxy endpoint for your API, your autogenerated proxy will already be correctly configured with the Autodiscovery element. (ccampbell: should we spell out what an autogenerated is?)

Configure the `api-gateway:Autodiscovery` element within your Mule application code. +
The Autodiscovery element refers to the specific API in API Manager with which you want to pair your application:

.XML element
[source,xml,linenums]
----
<api-gateway:autodiscovery
  apiId="${apiId}" // <1>
  flowRef="${myFlow}" /> // <2>
----

<1> Configure the `apiId` with the "API ID" that API Manager assigned to your API.
<2> Set the `flowRef` element to point to the flow that you want to pair with the API in API Manager.

You can either replace `${apiId}` with your identifier, or you can create a `config.properties` file where you define the identifier in a key-value pair: `apiId=[your-identifier]`.

You can also configure this using Anypoint Studio's UI:

. In your Mule flow, select the Global Elements tab in the Mule Configuration File editor.
. Click the Create button, and look for the API Autodiscovery global element in the UI.
+
image::auto-discovery-studio-7.png[align=center]
. Set the "API ID" and Flow Reference. +
+
image::auto-discovery-api-config.png[align=center]
+

After defining the element in your Mule application, Mule will automatically keep the API configuration up to date.
//_COMBAK: Does this need to be deployed for the green dot to show in API Manager?

== Changes from Mule 3.x Configuration

The API Autodiscovery element syntax has changed from Mule 3.x but its purpose remains the same. The following describes the new format:

[%header%autowidth.spread,cols="a,a"]
|===
^| Mule 3.x XML element ^| Mule 4.x XML element
^| <api-platform-gw:api (...)/>. ^| <api-gateway:autodiscovery (...)/>.
|===

In Mule 4, the API is identified by the API Id and a reference to a Flow where the HTTP listener is defined. Mule 4â€™s apiId replaces the apiName and apiVersion used to specify the Autodiscovery element in Mule 3.x and prior.

== See Also

* xref:api-auto-discovery-new-concept.adoc[Reviewing API Gateway API Autodiscovery concepts
